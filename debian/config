#! /bin/sh
# config script for webalizer
#
# see: dh_installdeb(1)

set -e

# bogus - though necessary - rule
. /usr/share/debconf/confmodule
db_version 2.0

case "$1" in
    configure)
      if [ "$2" ] && dpkg --compare-versions $2 lt 2.01.6-1; then
        db_input high webalizer/upgrading || true
        db_go
      fi

      if [ "$2" ] && dpkg --compare-versions $2 lt 2.01.10-30; then
        db_input high webalizer/upgrade2011030 || true
        db_go
      fi

      if [ -f "/etc/webalizer.conf" ] && [ ! -f "/etc/webalizer/webalizer.conf" ]; then
        mv /etc/webalizer.conf /etc/webalizer/webalizer.conf;
        exit 0;  # already configured
      fi
      [ ! -f "/etc/webalizer/webalizer.conf" ] || exit 0;

      # Now determine the system's hostname and domainname
      HOSTNAME=$(/bin/hostname);

      # Ask for the directory the output should be put in
      db_input medium webalizer/directory || true
      db_go
      db_get webalizer/directory
      OUTPUTDIR="$RET";
      [ ! -z $OUTPUTDIR ] || OUTPUTDIR="/var/www/webalizer";

      if [ ! -d $OUTPUTDIR ]; then
        mkdir -p $OUTPUTDIR;
        if [ $? -eq 0 ]; then
          echo "$OUTPUTDIR created";
        else
          echo "Something went wrong...";
          exit 1;
        fi;
      fi

      # At this point, ask the user what the title of webalizer's reports should be
      db_input medium webalizer/doc_title || true
      db_go
      db_get webalizer/doc_title
      REPORTTITLE="$RET";
      [ ! -z "$REPORTTITLE" ] || REPORTTITLE="Usage statistics for";

      # Ask for the rotated logfile
      # by default  is access log file of apache, but if I found apache2 log file,
      # I changed default to this one.

      # apache2 found
      if [ -f /var/log/apache2/access.log.1 ] || [ -f /var/log/apache2/access.log ]; then
        LOGFILE="/var/log/apache2/access.log.1";
      else
        LOGFILE="/var/log/apache/access.log.1";
      fi

      db_set "webalizer/logfile" $LOGFILE || true
      db_input medium webalizer/logfile || true
      db_go
      db_get webalizer/logfile
      [ ! -z "$RET" ] || LOGFILE="$RET";

      # Finally put these variables in /etc/webalizer/webalizer.conf using sed
      cat /usr/share/doc/webalizer/examples/sample.conf.gz | gunzip | /bin/sed \
	-e "s/^#HostName .*/HostName ${HOSTNAME}/" \
	-e "s|^#OutputDir .*|OutputDir ${OUTPUTDIR}|" \
	-e "s/^#ReportTitle .*/ReportTitle ${REPORTTITLE}/" \
	-e "s|^#LogFile .*|LogFile ${LOGFILE}|" \
	> /etc/webalizer/webalizer.conf;
    ;;

    reconfigure)
        exit 1;
    ;;

    *)
        echo "config called with unknown argument \`$1'" >&2;
        exit 1;
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

exit 0
