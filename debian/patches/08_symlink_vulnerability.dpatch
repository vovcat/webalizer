#! /bin/sh /usr/share/dpatch/dpatch-run
## 08_symlink_vulnerability.dpatch by Jose Carlos Medeiros <debian@psabs.com.br>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Solve a symlink vulnerability

# Webalizer has a symlink vulnerability, which potentially
# allows an unprivileged user to cause a root-owned file to be overwritten.
# The vulnerability occurs if the user has write permission to the directory
# into which Webalizer will write its output, and Webalizer is run as a more
# privileged user (e.g. as root, from a system-wide cron job); a user can
# create a symlink from any of the filenames Webalizer writes (e.g. index.html)
# to any other file on the system, and Webalizer will write to the symlink's
# target.
#
# The attacker may also have some control over the contents with which the
# symlink's target will be overwritten, by making specially-crafted HTTP
# requests which will be written into the log file being parsed; some of the
# HTML files output by Webalizer contain strings pulled from the input log file.

# THIS PATCH SOLVE THIS BUG.  Thanks to Julien Danjou <acid@debian.org> that
# sent this patch


@DPATCH@
Index: webalizer-2.01.10-vc/graphs.c
===================================================================
--- webalizer-2.01.10-vc.orig/graphs.c	2006-10-27 14:31:27.000000000 +0400
+++ webalizer-2.01.10-vc/graphs.c	2006-10-27 14:31:30.000000000 +0400
@@ -30,6 +30,8 @@
 #include <stdio.h>
 #include <string.h>
 #include <sys/types.h>
+#include <unistd.h>
+#include <sys/stat.h>
 #include <gd.h>
 #include <gdfontt.h>
 #include <gdfonts.h>
@@ -69,6 +71,7 @@

 gdImagePtr	im;                        /* image buffer        */
 FILE		*out;                      /* output file for PNG */
+struct stat	out_stat;                  /* stat struct for PNG */
 char		maxvaltxt[32];             /* graph values        */
 float		percent;                   /* percent storage     */
 u_int64_t		julday;                    /* julday value        */
@@ -275,6 +278,18 @@
       gdImageRectangle(im, x1, y1, x2, 232, black);
    }

+   /* stat the file */
+   if ( !(lstat(fname, &out_stat)) )
+   {
+     /* check if the file a symlink */
+     if ( S_ISLNK(out_stat.st_mode) )
+     {
+       if (verbose)
+       fprintf(stderr,"%s %s!\n","Error: File is a symlink",fname);
+       return;
+     }
+   }
+
    /* save png image */
    if ((out = fopen(fname, "wb")) != NULL)
    {
@@ -482,6 +497,18 @@
       gdImageRectangle(im, x1, y1, x2, 375, black);
    }

+   /* stat the file */
+   if ( !(lstat(fname, &out_stat)) )
+   {
+     /* check if the file a symlink */
+     if ( S_ISLNK(out_stat.st_mode) )
+     {
+       if (verbose)
+       fprintf(stderr,"%s %s!\n","Error: File is a symlink",fname);
+       return;
+     }
+   }
+
    /* open file for writing */
    if ((out = fopen(fname, "wb")) != NULL)
    {
@@ -589,6 +616,18 @@
       gdImageRectangle(im, x1, y1, x2, 232, black);
    }

+   /* stat the file */
+   if ( !(lstat(fname, &out_stat)) )
+   {
+     /* check if the file a symlink */
+     if ( S_ISLNK(out_stat.st_mode) )
+     {
+       if (verbose)
+       fprintf(stderr,"%s %s!\n","Error: File is a symlink",fname);
+       return(1);
+     }
+   }
+
    /* save as png	file */
    if ( (out = fopen(fname, "wb")) != NULL)
    {
@@ -673,6 +712,18 @@
       gdImageString(im,gdFontMediumBold, x, y, buffer, white);
    }

+   /* stat the file */
+   if ( !(lstat(fname, &out_stat)) )
+   {
+     /* check if the file a symlink */
+     if ( S_ISLNK(out_stat.st_mode) )
+     {
+       if (verbose)
+       fprintf(stderr,"%s %s!\n","Error: File is a symlink",fname);
+       return;
+     }
+   }
+
    /* save png image */
    if ((out = fopen(fname, "wb")) != NULL)
    {
Index: webalizer-2.01.10-vc/output.c
===================================================================
--- webalizer-2.01.10-vc.orig/output.c	2006-10-27 14:31:29.000000000 +0400
+++ webalizer-2.01.10-vc/output.c	2006-10-27 14:31:30.000000000 +0400
@@ -38,6 +38,7 @@
 #include <ctype.h>
 #include <sys/utsname.h>
 #include <sys/times.h>
+#include <sys/stat.h>

 /* ensure getopt */
 #ifdef HAVE_GETOPT_H
@@ -2393,7 +2394,7 @@
    /* now do html stuff... */
    sprintf(index_fname,"index.%s",html_ext);

-   if ( (out_fp=fopen(index_fname,"w")) == NULL)
+   if ( (out_fp=open_out_file(index_fname)) == NULL)
    {
       if (verbose)
       fprintf(stderr,"%s %s!\n",msg_no_open,index_fname);
@@ -2964,8 +2965,21 @@

 FILE *open_out_file(char *filename)
 {
+   struct stat out_stat;
    FILE *out_fp;

+   /* stat the file */
+   if ( !(lstat(filename, &out_stat)) )
+   {
+      /* check if the file a symlink */
+      if ( S_ISLNK(out_stat.st_mode) )
+      {
+        if (verbose)
+        fprintf(stderr,"%s %s!\n","Error: File is a symlink",filename);
+        return NULL;
+      }
+   }
+
    /* open the file... */
    if ( (out_fp=fopen(filename,"w")) == NULL)
    {
Index: webalizer-2.01.10-vc/preserve.c
===================================================================
--- webalizer-2.01.10-vc.orig/preserve.c	2006-10-27 14:31:27.000000000 +0400
+++ webalizer-2.01.10-vc/preserve.c	2006-10-27 14:31:30.000000000 +0400
@@ -38,6 +38,7 @@
 #include <ctype.h>
 #include <sys/utsname.h>
 #include <sys/times.h>
+#include <sys/stat.h>

 /* ensure getopt */
 #ifdef HAVE_GETOPT_H
@@ -141,6 +142,19 @@
 {
    int i;
    FILE *hist_fp;
+   struct stat hist_stat;
+
+   /* stat the file */
+   if ( !(lstat(hist_fname, &hist_stat)) )
+   {
+     /* check if the file a symlink */
+     if ( S_ISLNK(hist_stat.st_mode) )
+     {
+       if (verbose)
+       fprintf(stderr,"%s %s!\n","Error: File is a symlink",hist_fname);
+       return;
+     }
+   }

    hist_fp = fopen(hist_fname,"w");

@@ -186,9 +200,22 @@

    FILE *fp;
    int  i;
+   struct stat state_stat;

    char buffer[BUFSIZE];

+   /* stat the file */
+   if ( !(lstat(state_fname, &state_stat)) )
+   {
+     /* check if the file a symlink */
+     if ( S_ISLNK(state_stat.st_mode) )
+     {
+       if (verbose)
+       fprintf(stderr,"%s %s!\n","Error: File is a symlink",state_fname);
+       return NULL;
+     }
+   }
+
    /* Open data file for write */
    fp=fopen(state_fname,"w");
    if (fp==NULL) return 1;
Index: webalizer-2.01.10-vc/webalizer.c
===================================================================
--- webalizer-2.01.10-vc.orig/webalizer.c	2006-10-27 14:31:29.000000000 +0400
+++ webalizer-2.01.10-vc/webalizer.c	2006-10-27 14:31:30.000000000 +0400
@@ -39,6 +39,7 @@
 #include <sys/utsname.h>
 #include <sys/times.h>
 #include <zlib.h>
+#include <sys/stat.h>

 /* ensure getopt */
 #ifdef HAVE_GETOPT_H
@@ -267,6 +268,7 @@
                          "apr", "may", "jun",
                          "jul", "aug", "sep",
                          "oct", "nov", "dec"};
+   struct stat log_stat;

    /* initalize epoch */
    epoch=jdate(1,1,1970);                /* used for timestamp adj.     */
@@ -428,6 +430,18 @@
    /* open log file */
    if (gz_log)
    {
+       /* stat the file */
+       if ( !(lstat(log_fname, &log_stat)) )
+       {
+         /* check if the file a symlink */
+         if ( S_ISLNK(log_stat.st_mode) )
+         {
+           if (verbose)
+           fprintf(stderr,"%s %s!\n","Error: File is a symlink",log_fname);
+           return;
+         }
+      }
+
       gzlog_fp = gzopen(log_fname,"rb");
       if (gzlog_fp==Z_NULL)
       {
